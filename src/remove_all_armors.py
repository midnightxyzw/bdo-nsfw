import pathlib, shutil, re, fnmatch
import meta_file, remove_underwear, patcher

# Non pearl armor patterns
free_items_regex = re.compile(
    r""".*(
                           _0[1|2|3]_.*_\d{4} # this is the default pattern for non cash shop armors
                           ).*""",
    re.VERBOSE,
)


def is_female_free_items(block: meta_file.FileBlock):
    fullPath = str(block.fullPath())
    return remove_underwear.female_regex.match(fullPath) and free_items_regex.match(fullPath)


def is_female_pearl_items(block: meta_file.FileBlock):
    fullPath = str(block.fullPath())
    return remove_underwear.female_regex.match(fullPath) and (not free_items_regex.match(fullPath))


def is_male_free_items(block: meta_file.FileBlock):
    fullPath = str(block.fullPath())
    return (not remove_underwear.female_regex.match(fullPath)) and free_items_regex.match(fullPath)


def is_male_pearl_items(block: meta_file.FileBlock):
    fullPath = str(block.fullPath())
    return (not remove_underwear.female_regex.match(fullPath)) and (not free_items_regex.match(fullPath))


def patch_models(what: str, outDir: pathlib.Path, meta: meta_file.MetaFile, additional_requirement: callable = None):
    inclusion_patterns = [
        "9_upperbody",
        "10_lowerbody",
        "11_hand",
        # "12_foot", keep boots on to avoid heel floating
        # "13_hel", keep helmets on to avoid missing hair/head
        "14_sho",
        "15_underup",
        "19_cloak",
        "event_costume",
    ]

    def is_armor(block):
        if not any([p in block.folderName for p in inclusion_patterns]):
            return False
        if additional_requirement is not None and not additional_requirement(block):
            return False
        return True

    patcher.hide_player_models(what, outDir, meta, is_armor)


def patch_textures(what: str, outDir: pathlib.Path, meta: meta_file.MetaFile, additional_requirement: callable = None):
    underwear_pattern = re.compile(r"_\d{2}_uw_|_99_ub_")
    armor_pattern = re.compile(r"p[a-z]+_(\d{2}|ew)_(ub|lb|hand|sho|underup|cloak)_")

    def is_armor_texture(block):
        # Ignore files already patched by remove_underwear.py
        if underwear_pattern.search(block.fileName):
            return False
        # Check if it is an armor texture
        if not armor_pattern.search(block.fileName):
            return False
        # check against user provided conditions.
        if additional_requirement is not None and not additional_requirement(block):
            return False
        return True

    patcher.patch_player_ao_textures(what, outDir, meta, is_armor_texture)


def remove_all_armors(outDir: pathlib.Path, meta: meta_file.MetaFile):
    # female free items
    patch_models("Hide female free armor models", outDir / "_female_free_items", meta, is_female_free_items)
    patch_textures("Patch female free armor AO textures", outDir / "_female_free_items", meta, is_female_free_items)

    # female pearl items
    patch_models("Hide female pearl armor models", outDir / "_female_pearl_items", meta, is_female_pearl_items)
    patch_textures("Patch female pearl armor AO textures", outDir / "_female_pearl_items", meta, is_female_pearl_items)

    # male free items
    patch_models("Hide male free armor models", outDir / "_male_free_items", meta, is_male_free_items)
    patch_textures("Patch male free armor AO textures", outDir / "_male_free_items", meta, is_male_free_items)

    # male pearl items
    patch_models("Hide male pearl armor models", outDir / "_male_pearl_items", meta, is_male_pearl_items)
    patch_textures("Patch male pearl armor AO textures", outDir / "_male_pearl_items", meta, is_male_pearl_items)

    # generate a readme file
    with open(outDir / ".README.md", "w") as f:
        f.write(
            """# What's this?

This folder contains patch files to hide all armors, except boots,
from all playable classes, except Shai, up to release of Scholar.

Generated by Midnight Xyzw (https://github.com/midnightxyzw/bdo-nsfw)

# How to use it?

- Put it under files_to_patch folder.
- Run PartCutGen.exe to refresh your partcuts_desc.xml
- Run Meta Injector.exe to patch your game.
"""
        )
